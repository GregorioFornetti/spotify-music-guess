var B=Object.defineProperty;var N=(e,t,s)=>t in e?B(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var a=(e,t,s)=>(N(e,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=s(i);fetch(i.href,o)}})();const P="https://gregoriofornetti.github.io/spotify-music-guess/dist";async function A(e){const t=R(128),s=await D(t);localStorage.setItem("verifier",t);const n=new URLSearchParams;n.append("client_id",e),n.append("response_type","code"),n.append("redirect_uri",P),n.append("scope","user-read-private user-read-email user-modify-playback-state user-read-playback-state"),n.append("code_challenge_method","S256"),n.append("code_challenge",s),document.location=`https://accounts.spotify.com/authorize?${n.toString()}`}async function M(e,t){if(localStorage.getItem("acess_token")){const s=localStorage.getItem("refresh_token"),n=new URLSearchParams;n.append("client_id",e),n.append("grant_type","refresh_token"),n.append("refresh_token",s);const i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}),{access_token:o,refresh_token:l}=await i.json();return o&&localStorage.setItem("acess_token",o),l&&localStorage.setItem("refresh_token",l),o}else{const s=localStorage.getItem("verifier"),n=new URLSearchParams;n.append("client_id",e),n.append("grant_type","authorization_code"),n.append("code",t),n.append("redirect_uri",P),n.append("code_verifier",s);const i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}),{access_token:o,refresh_token:l}=await i.json();return o&&localStorage.setItem("acess_token",o),l&&localStorage.setItem("refresh_token",l),o}}function R(e){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;n++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}async function D(e){const t=new TextEncoder().encode(e),s=await window.crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode.apply(null,[...new Uint8Array(s)])).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function p(e){var s;const t=(s=document.getElementById("main"))==null?void 0:s.children;if(t)for(let n=0;n<t.length;n++){const i=t[n];i.style.display="none",i.id===e&&(i.style.display="block")}}function f(e,t){var n;const s=(n=document.getElementById(e))==null?void 0:n.children;if(s)for(let i=0;i<s.length;i++){const o=s[i];o.style.display="none",o.id===t&&(o.style.display="block")}}class c{static get accessToken(){return this._accessToken}static get accessTokenHeader(){return{Authorization:`Bearer ${this._accessToken}`}}static set accessToken(t){this._accessToken=t}static get country(){return this._country}static set country(t){this._country=t}}a(c,"_accessToken",""),a(c,"_country","");async function O(){return(await fetch("https://api.spotify.com/v1/me",{method:"GET",headers:c.accessTokenHeader}).then(t=>t.json())).country}const w="([A-Za-z0-9]{22})",H=new RegExp(`^${w}$`),v=new RegExp(`^spotify:playlist:${w}$`),T=new RegExp(`^https://open.spotify.com/playlist/${w}(\\?si=.*)?$`);function F(e){return H.test(e)}function U(e){return v.test(e)}function $(e){return T.test(e)}function Q(e){return e.match(v)[1]}function j(e){return e.match(T)[1]}function q(e){if(e=e.trim(),U(e))return Q(e);if($(e))return j(e);if(F(e))return e;throw new Error("URI, URL ou ID inválido.")}function g(e){const t=document.createElement("div");t.classList.add("music");const s=document.createElement("img");s.classList.add("music-image");const n=document.createElement("p");n.classList.add("music-name"),n.innerText=e.name;const i=document.createElement("p");return i.classList.add("music-artist"),e.type==="track"?(e.album.images.length!==0&&s.setAttribute("src",e.album.images[0].url),i.innerText=e.artists[0].name):e.type==="episode"&&(e.images.length!==0&&s.setAttribute("src",e.images[0].url),i.innerText=e.show.name),t.appendChild(s),t.appendChild(n),t.appendChild(i),t}class r{static reset(){this.resetCorrectAnswerCount(),this.resetRoundNumber()}static get pageId(){return"rounds-mode-game-page"}static get playlist(){return this._playlist}static set playlist(t){this._playlist=t}static get playlistId(){return this._playlistId}static set playlistId(t){this._playlistId=t}static get roundNumber(){return this._roundNumber}static resetRoundNumber(){this._roundNumber=1}static increaseRoundNumber(){if(this._totalRounds<=this._roundNumber)throw new Error("Número do round não pode ser maior que o número total de rounds");this._roundNumber++}static get totalRounds(){return this._totalRounds}static set totalRounds(t){this._totalRounds=t}static get correctAnswersCount(){return this._correctAnswerCount}static resetCorrectAnswerCount(){this._correctAnswerCount=0}static increaseCorrectAnswerCount(){if(this._totalRounds<=this._correctAnswerCount)throw new Error("Número do round não pode ser maior que o número total de rounds");this._correctAnswerCount++}static get musicPos(){return this._musicPos}static set musicPos(t){this._musicPos=t}static get musicPlaytime(){return this._musicPlaytime}static set musicPlaytime(t){this._musicPlaytime=t}static get musicsQnt(){return this._musicsQnt}static set musicsQnt(t){this._musicsQnt=t}static get extraTries(){return this._extraTries}static set extraTries(t){this._extraTries=t}}a(r,"_playlist"),a(r,"_playlistId"),a(r,"_roundNumber"),a(r,"_correctAnswerCount"),a(r,"_totalRounds"),a(r,"_musicPos"),a(r,"_musicPlaytime"),a(r,"_musicsQnt"),a(r,"_extraTries");function z(){document.getElementById("final-result-correct-count").innerText=r.correctAnswersCount.toString(),document.getElementById("final-result-total-rounds").innerText=r.totalRounds.toString(),f(r.pageId,"final-result-rounds-subpage")}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.getElementById("final-result-return"))==null||e.addEventListener("click",()=>{p("playlist-selection-page")})});function V(e,t){e.id===t.id?(document.getElementById("song-result-message").innerText="Você acertou !",r.increaseCorrectAnswerCount()):document.getElementById("song-result-message").innerText="Você errou !",document.getElementById("song-result-current-round").innerText=r.roundNumber.toString(),document.getElementById("song-result-total-rounds").innerText=r.totalRounds.toString();const s=document.getElementById("song-result-correct-song");s.innerHTML="",s.appendChild(g(e));const n=document.getElementById("song-result-guessed-song");n.innerHTML="",n.appendChild(g(t)),f(r.pageId,"song-result-rounds-subpage")}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.getElementById("song-result-next"))==null||e.addEventListener("click",()=>{r.roundNumber===r.totalRounds?z():(r.increaseRoundNumber(),C())})});function G(e,t){return t.filter(s=>s.track.name.toLowerCase().includes(e.toLowerCase()))}function J(e,t){return t.filter(s=>s.track.type==="episode"?s.track.show.name.toLowerCase().includes(e.toLowerCase()):s.track.type==="track"?s.track.artists[0].name.toLowerCase().includes(e.toLowerCase()):!1)}function K(e,t,s){return G(e,J(t,s))}function _(e){let t=[...e];for(let s=t.length-1;s>0;s--){const n=Math.floor(Math.random()*(s+1));[t[s],t[n]]=[t[n],t[s]]}return t}function L(){fetch("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:c.accessTokenHeader})}function Z(e,t,s,n){let i=0;return n&&(i=n),fetch("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:c.accessTokenHeader,body:JSON.stringify({context_uri:`spotify:playlist:${s}`,position_ms:i,offset:{position:e}})}),setTimeout(()=>{L()},t*1e3)}class x{constructor(t,s,n,i){a(this,"musicFullDuration");a(this,"playlistId");a(this,"musicNumber");a(this,"musicPlaytimes");a(this,"currentIndex");a(this,"musicPlaytime");a(this,"timeoutId");this.musicNumber=n,this.currentIndex=0,this.musicPlaytimes=[],this.musicFullDuration=t.tracks.items[this.musicNumber].track.duration_ms,this.playlistId=s,this.musicPlaytime=i,this.constructPlaytimes()}play(){if(!this.finished){let t=this.musicPlaytime;this.musicPlaytimes[this.currentIndex]+t*1e3>this.musicFullDuration&&(t=(this.musicFullDuration-this.musicPlaytimes[this.currentIndex])/1e3-.01),console.log("tocando musica de número "+this.musicNumber),this.timeoutId=Z(this.musicNumber,t,this.playlistId,this.musicPlaytimes[this.currentIndex]),this.currentIndex+=1}}pause(){clearTimeout(this.timeoutId),L()}get finished(){return this.currentIndex>=this.musicPlaytimes.length}}class W extends x{constructPlaytimes(){this.musicPlaytimes.push(0);let t=this.musicPlaytime*1e3;for(;t<this.musicFullDuration;)this.musicPlaytimes.push(t),t+=this.musicPlaytime*1e3;this.musicPlaytimes=_(this.musicPlaytimes)}}class X extends x{constructPlaytimes(){this.musicPlaytimes.push(0);let t=this.musicPlaytime*1e3;for(;t<this.musicFullDuration;)this.musicPlaytimes.push(t),t+=this.musicPlaytime*1e3}}var u=null,d=null,m,E,h,y;function Y(){m=_([...Array(r.playlist.tracks.items.length).keys()]),console.log("musicas sorteadas: "),console.log(m),u=null,d=null;const e=document.getElementById("song-guess-hear-next");r.extraTries?e.disabled=!1:e.disabled=!0,C()}function C(){const e=document.getElementById("song-guess-input"),t=document.getElementById("artist-guess-input");if(e.value="",t.value="",r.playlist.tracks.items.length===r.musicsQnt)y=r.playlist.tracks.items;else{let s=[m[r.roundNumber-1]],n=[...m];delete n[r.roundNumber-1],n=_(n);for(let i=0;i<r.musicsQnt-1;i++)s.push(n[i]);s.sort(),y=s.map(i=>r.playlist.tracks.items[i])}S(y),r.musicPos==="random"?E=W:r.musicPos==="start"&&(E=X),h=new E(r.playlist,r.playlistId,m[r.roundNumber-1],r.musicPlaytime),h.play(),f(r.pageId,"song-guess-rounds-subpage")}function S(e){u=null;const t=document.getElementById("playlist-tracks-list-game");t.innerHTML="";for(let s of e){const n=g(s.track);n.classList.add("clickable"),n.addEventListener("click",()=>{u&&u.classList.remove("selected"),u=n,u.classList.add("selected"),d=s.track}),d&&s.track.id===d.id&&(u=n,u.classList.add("selected")),t.appendChild(n)}}document.addEventListener("DOMContentLoaded",()=>{var n,i;const e=document.getElementById("song-guess-input"),t=document.getElementById("artist-guess-input"),s=()=>{S(K(e.value,t.value,y))};e.addEventListener("input",s),t.addEventListener("input",s),(n=document.getElementById("song-guess-submit"))==null||n.addEventListener("click",()=>{d&&(V(r.playlist.tracks.items[m[r.roundNumber-1]].track,d),d=null,u=null,h.pause())}),(i=document.getElementById("song-guess-hear-next"))==null||i.addEventListener("click",()=>{h.play()})});function ee(){const e=r.playlist.tracks.items.length;document.getElementById("configs-rounds-rounds-number").setAttribute("max",e.toString());const s=document.getElementById("configs-rounds-music-qnt");s.setAttribute("max",e.toString()),s.setAttribute("value",e.toString()),f(r.pageId,"configs-rounds-subpage")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("configs-rounds-form");e.addEventListener("submit",t=>{t.preventDefault();const s=new FormData(e);r.totalRounds=Number(s.get("rounds-number")),r.musicPos=s.get("music-pos"),r.musicPlaytime=Number(s.get("music-play-time")),r.musicsQnt=Number(s.get("music-qnt")),s.get("extra-tries")=="on"?r.extraTries=!0:r.extraTries=!1,e.reset(),Y()})});function te(e,t){r.reset(),r.playlist=e,r.playlistId=t,ee(),p(r.pageId)}function se(e,t){document.getElementById("playlist-image").setAttribute("src",e.images[0].url),document.getElementById("playlist-name").innerText=e.name,e.description?document.getElementById("playlist-description").innerText=e.description:document.getElementById("playlist-description").innerText="Sem descrição",e.owner.display_name?document.getElementById("playlist-owner").innerText=e.owner.display_name:document.getElementById("playlist-owner").innerText="",document.getElementById("playlist-tracks-count").innerText=String(e.tracks.total);const s=document.getElementById("playlist-tracks-list");s.innerHTML="";for(let n of e.tracks.items)s.appendChild(g(n.track));document.getElementById("game-start").onclick=()=>{te(e,t)},p("playlist-info-page")}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.getElementById("playlist-return"))==null||e.addEventListener("click",()=>{p("playlist-selection-page")})});function b(e){return e.track?e.track.is_playable:!1}async function ne(e){return fetch(`https://api.spotify.com/v1/playlists/${e}?market=${c.country}&additional_types=episode`,{method:"GET",headers:c.accessTokenHeader}).then(t=>t.json()).then(async t=>{var s=t.tracks.next;for(t.tracks.items=t.tracks.items.filter(b);s;)await fetch(s,{method:"GET",headers:c.accessTokenHeader}).then(n=>n.json()).then(n=>{t.tracks.items.push(...n.items.filter(b)),s=n.next});return t})}async function ie(){return fetch("https://api.spotify.com/v1/me/player/devices",{headers:c.accessTokenHeader,method:"GET"}).then(e=>e.json()).then(e=>e.devices)}function re(e){const t=document.createElement("div");t.classList.add("device"),e.is_active&&t.classList.add("selected");const s=document.createElement("p");return s.classList.add("device-name"),s.innerText=e.name,t.appendChild(s),t}async function oe(e){return fetch("https://api.spotify.com/v1/me/player",{headers:c.accessTokenHeader,method:"PUT",body:JSON.stringify({device_ids:[e]})})}async function ae(){await ie().then(e=>{const t=document.getElementById("devices-list");for(const s of e){const n=re(s);n.addEventListener("click",async()=>{if(s.id){await oe(s.id);for(let i=0;i<t.children.length;i++)t.children[i].classList.remove("selected");n.classList.add("selected")}}),t.appendChild(n)}e.length===0&&(t.innerHTML="<p>Nenhum dispositivo encontrado. Abra o spotify em algum dispositivo e recarregue a página para selecionar algum dispositivo para tocar as músicas</p>")})}document.addEventListener("DOMContentLoaded",async()=>{var e;(e=document.getElementById("playlist-form"))==null||e.addEventListener("submit",async t=>{t.preventDefault();const s=document.getElementById("playlist-input").value;try{const n=q(s),i=await ne(n);se(i,n)}catch(n){console.log(n)}})});const k="b3c2339a149d46afa94a39347466b623",ce=new URLSearchParams(window.location.search),I=ce.get("code");document.addEventListener("DOMContentLoaded",async()=>{p(""),I?(c.accessToken=await M(k,I),c.country=await O(),await ae(),p("playlist-selection-page")):A(k)});
