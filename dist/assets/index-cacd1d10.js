var U=Object.defineProperty;var F=(e,t,s)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var r=(e,t,s)=>(F(e,typeof t!="symbol"?t+"":t,s),s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();const S="https://gregoriofornetti.github.io/spotify-music-guess/dist";async function $(e){const t=Q(128),s=await q(t);localStorage.setItem("verifier",t);const n=new URLSearchParams;n.append("client_id",e),n.append("response_type","code"),n.append("redirect_uri",S),n.append("scope","user-read-private user-read-email user-modify-playback-state user-read-playback-state playlist-read-private playlist-read-collaborative user-library-read"),n.append("code_challenge_method","S256"),n.append("code_challenge",s),document.location=`https://accounts.spotify.com/authorize?${n.toString()}`}async function j(e,t){if(localStorage.getItem("acess_token")){const s=localStorage.getItem("refresh_token"),n=new URLSearchParams;n.append("client_id",e),n.append("grant_type","refresh_token"),n.append("refresh_token",s);const i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}),{access_token:a,refresh_token:c}=await i.json();return a&&localStorage.setItem("acess_token",a),c&&localStorage.setItem("refresh_token",c),a}else{const s=localStorage.getItem("verifier"),n=new URLSearchParams;n.append("client_id",e),n.append("grant_type","authorization_code"),n.append("code",t),n.append("redirect_uri",S),n.append("code_verifier",s);const i=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n}),{access_token:a,refresh_token:c}=await i.json();return a&&localStorage.setItem("acess_token",a),c&&localStorage.setItem("refresh_token",c),a}}function Q(e){let t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<e;n++)t+=s.charAt(Math.floor(Math.random()*s.length));return t}async function q(e){const t=new TextEncoder().encode(e),s=await window.crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode.apply(null,[...new Uint8Array(s)])).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const G={"empty-page":"none","home-page":"grid","playlist-info-page":"block","rounds-mode-game-page":"block"};function y(e){var s;const t=(s=document.getElementById("main"))==null?void 0:s.children;if(t)for(let n=0;n<t.length;n++){const i=t[n];i.style.display="none",i.id===e&&(i.style.display=G[e])}}function z(e,t){var n;const s=(n=document.getElementById(e))==null?void 0:n.children;if(s)for(let i=0;i<s.length;i++){const a=s[i];a.style.display="none",a.id===t&&(a.style.display="block")}}class l{static get accessToken(){return this._accessToken}static get accessTokenHeader(){return{Authorization:`Bearer ${this._accessToken}`}}static set accessToken(t){this._accessToken=t}static get country(){return this._country}static set country(t){this._country=t}}r(l,"_accessToken",""),r(l,"_country","");async function J(){return(await fetch("https://api.spotify.com/v1/me",{method:"GET",headers:l.accessTokenHeader}).then(t=>t.json())).country}const _="([A-Za-z0-9]{22})",V=new RegExp(`^${_}$`),B=new RegExp(`^spotify:playlist:${_}$`),N=new RegExp(`^https://open.spotify.com/playlist/${_}(\\?si=.*)?$`);function K(e){return V.test(e)}function Z(e){return B.test(e)}function W(e){return N.test(e)}function X(e){return e.match(B)[1]}function Y(e){return e.match(N)[1]}function ee(e){if(e=e.trim(),Z(e))return X(e);if(W(e))return Y(e);if(K(e))return e;throw new Error("URI, URL ou ID inválido.")}function g(e){const t=document.createElement("div");t.classList.add("music");const s=document.createElement("img");s.classList.add("music-image");const n=document.createElement("p");n.classList.add("music-name"),n.innerText=e.name;const i=document.createElement("p");return i.classList.add("music-artist"),e.type==="track"?(e.album.images.length!==0&&s.setAttribute("src",e.album.images[0].url),i.innerText=e.artists[0].name):e.type==="episode"&&(e.images.length!==0&&s.setAttribute("src",e.images[0].url),i.innerText=e.show.name),t.appendChild(s),t.appendChild(n),t.appendChild(i),t}class o{static reset(){this.resetCorrectAnswerCount(),this.resetRoundNumber()}static get playlist(){return this._playlist}static set playlist(t){this._playlist=t}static get playlistId(){return this._playlistId}static set playlistId(t){this._playlistId=t}static get roundNumber(){return this._roundNumber}static resetRoundNumber(){this._roundNumber=1}static increaseRoundNumber(){if(this._totalRounds<=this._roundNumber)throw new Error("Número do round não pode ser maior que o número total de rounds");this._roundNumber++}static get totalRounds(){return this._totalRounds}static set totalRounds(t){this._totalRounds=t}static get correctAnswersCount(){return this._correctAnswerCount}static resetCorrectAnswerCount(){this._correctAnswerCount=0}static increaseCorrectAnswerCount(){if(this._totalRounds<=this._correctAnswerCount)throw new Error("Número do round não pode ser maior que o número total de rounds");this._correctAnswerCount++}static get musicPos(){return this._musicPos}static set musicPos(t){this._musicPos=t}static get musicPlaytime(){return this._musicPlaytime}static set musicPlaytime(t){this._musicPlaytime=t}static get musicsQnt(){return this._musicsQnt}static set musicsQnt(t){this._musicsQnt=t}static get extraTries(){return this._extraTries}static set extraTries(t){this._extraTries=t}}r(o,"_playlist"),r(o,"_playlistId"),r(o,"_roundNumber"),r(o,"_correctAnswerCount"),r(o,"_totalRounds"),r(o,"_musicPos"),r(o,"_musicPlaytime"),r(o,"_musicsQnt"),r(o,"_extraTries");function v(e){z("rounds-mode-game-page",e)}function te(){document.getElementById("final-result-correct-count").innerText=o.correctAnswersCount.toString(),document.getElementById("final-result-total-rounds").innerText=o.totalRounds.toString(),v("final-result-rounds-subpage")}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.getElementById("final-result-return"))==null||e.addEventListener("click",()=>{y("home-page")})});function se(e,t){e.id===t.id?(document.getElementById("song-result-message").innerText="Você acertou !",o.increaseCorrectAnswerCount()):document.getElementById("song-result-message").innerText="Você errou !",document.getElementById("song-result-current-round").innerText=o.roundNumber.toString(),document.getElementById("song-result-total-rounds").innerText=o.totalRounds.toString();const s=document.getElementById("song-result-correct-song");s.innerHTML="",s.appendChild(g(e));const n=document.getElementById("song-result-guessed-song");n.innerHTML="",n.appendChild(g(t)),v("song-result-rounds-subpage")}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.getElementById("song-result-next"))==null||e.addEventListener("click",()=>{o.roundNumber===o.totalRounds?te():(o.increaseRoundNumber(),A())})});function ne(e,t){return t.filter(s=>s.track.name.toLowerCase().includes(e.toLowerCase()))}function ie(e,t){return t.filter(s=>s.track.type==="episode"?s.track.show.name.toLowerCase().includes(e.toLowerCase()):s.track.type==="track"?s.track.artists[0].name.toLowerCase().includes(e.toLowerCase()):!1)}function oe(e,t,s){return ne(e,ie(t,s))}function P(e){let t=[...e];for(let s=t.length-1;s>0;s--){const n=Math.floor(Math.random()*(s+1));[t[s],t[n]]=[t[n],t[s]]}return t}function M(){fetch("https://api.spotify.com/v1/me/player/pause",{method:"PUT",headers:l.accessTokenHeader})}function ae(e,t,s,n){let i=0;return n&&(i=n),fetch("https://api.spotify.com/v1/me/player/play",{method:"PUT",headers:l.accessTokenHeader,body:JSON.stringify({context_uri:`spotify:playlist:${s}`,position_ms:i,offset:{position:e}})}),setTimeout(()=>{M()},t*1e3)}class R{constructor(t,s,n,i){r(this,"musicFullDuration");r(this,"playlistId");r(this,"musicNumber");r(this,"musicPlaytimes");r(this,"currentIndex");r(this,"musicPlaytime");r(this,"timeoutId");this.musicNumber=n,this.currentIndex=0,this.musicPlaytimes=[],this.musicFullDuration=t.tracks.items[this.musicNumber].track.duration_ms,this.playlistId=s,this.musicPlaytime=i,this.constructPlaytimes()}play(){if(!this.finished){let t=this.musicPlaytime;this.musicPlaytimes[this.currentIndex]+t*1e3>this.musicFullDuration&&(t=(this.musicFullDuration-this.musicPlaytimes[this.currentIndex])/1e3-.01),console.log("tocando musica de número "+this.musicNumber),this.timeoutId=ae(this.musicNumber,t,this.playlistId,this.musicPlaytimes[this.currentIndex]),this.currentIndex+=1}}pause(){clearTimeout(this.timeoutId),M()}get finished(){return this.currentIndex>=this.musicPlaytimes.length}}class re extends R{constructPlaytimes(){this.musicPlaytimes.push(0);let t=this.musicPlaytime*1e3;for(;t<this.musicFullDuration;)this.musicPlaytimes.push(t),t+=this.musicPlaytime*1e3;this.musicPlaytimes=P(this.musicPlaytimes)}}class ce extends R{constructPlaytimes(){this.musicPlaytimes.push(0);let t=this.musicPlaytime*1e3;for(;t<this.musicFullDuration;)this.musicPlaytimes.push(t),t+=this.musicPlaytime*1e3}}var d=null,u=null,p,k,f,h;function le(){p=P([...Array(o.playlist.tracks.items.length).keys()]),console.log("musicas sorteadas: "),console.log(p),d=null,u=null;const e=document.getElementById("song-guess-hear-next");o.extraTries?e.disabled=!1:e.disabled=!0,A()}function A(){const e=document.getElementById("song-guess-input"),t=document.getElementById("artist-guess-input");if(e.value="",t.value="",o.playlist.tracks.items.length===o.musicsQnt)h=o.playlist.tracks.items;else{let s=[p[o.roundNumber-1]],n=[...p];delete n[o.roundNumber-1],n=P(n);for(let i=0;i<o.musicsQnt-1;i++)s.push(n[i]);s.sort(),h=s.map(i=>o.playlist.tracks.items[i])}D(h),o.musicPos==="random"?k=re:o.musicPos==="start"&&(k=ce),f=new k(o.playlist,o.playlistId,p[o.roundNumber-1],o.musicPlaytime),f.play(),v("song-guess-rounds-subpage")}function D(e){d=null;const t=document.getElementById("playlist-tracks-list-game");t.innerHTML="";for(let s of e){const n=g(s.track);n.classList.add("clickable"),n.addEventListener("click",()=>{d&&d.classList.remove("selected"),d=n,d.classList.add("selected"),u=s.track}),u&&s.track.id===u.id&&(d=n,d.classList.add("selected")),t.appendChild(n)}}document.addEventListener("DOMContentLoaded",()=>{var n,i;const e=document.getElementById("song-guess-input"),t=document.getElementById("artist-guess-input"),s=()=>{D(oe(e.value,t.value,h))};e.addEventListener("input",s),t.addEventListener("input",s),(n=document.getElementById("song-guess-submit"))==null||n.addEventListener("click",()=>{u&&(se(o.playlist.tracks.items[p[o.roundNumber-1]].track,u),u=null,d=null,f.pause())}),(i=document.getElementById("song-guess-hear-next"))==null||i.addEventListener("click",()=>{f.play()})});function de(){const e=o.playlist.tracks.items.length;document.getElementById("configs-rounds-rounds-number").setAttribute("max",e.toString());const s=document.getElementById("configs-rounds-music-qnt");s.setAttribute("max",e.toString()),s.setAttribute("value",e.toString()),v("configs-rounds-subpage")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("configs-rounds-form");e.addEventListener("submit",t=>{t.preventDefault();const s=new FormData(e);o.totalRounds=Number(s.get("rounds-number")),o.musicPos=s.get("music-pos"),o.musicPlaytime=Number(s.get("music-play-time")),o.musicsQnt=Number(s.get("music-qnt")),s.get("extra-tries")=="on"?o.extraTries=!0:o.extraTries=!1,e.reset(),le()})});function ue(e,t){o.reset(),o.playlist=e,o.playlistId=t,de(),y("rounds-mode-game-page")}function me(e,t){document.getElementById("playlist-image").setAttribute("src",e.images[0].url),document.getElementById("playlist-name").innerText=e.name,e.description?document.getElementById("playlist-description").innerText=e.description:document.getElementById("playlist-description").innerText="Sem descrição",e.owner.display_name?document.getElementById("playlist-owner").innerText=e.owner.display_name:document.getElementById("playlist-owner").innerText="",document.getElementById("playlist-tracks-count").innerText=String(e.tracks.total);const s=document.getElementById("playlist-tracks-list");s.innerHTML="";for(let n of e.tracks.items)s.appendChild(g(n.track));document.getElementById("game-start").onclick=()=>{ue(e,t)},y("playlist-info-page")}document.addEventListener("DOMContentLoaded",()=>{var e;(e=document.getElementById("playlist-return"))==null||e.addEventListener("click",()=>{y("home-page")})});function T(e){return e.track?e.track.is_playable:!1}async function O(e){return fetch(`https://api.spotify.com/v1/playlists/${e}?market=${l.country}&additional_types=episode`,{method:"GET",headers:l.accessTokenHeader}).then(t=>t.json()).then(async t=>{var s=t.tracks.next;for(t.tracks.items=t.tracks.items.filter(T);s;)await fetch(s,{method:"GET",headers:l.accessTokenHeader}).then(n=>n.json()).then(n=>{t.tracks.items.push(...n.items.filter(T)),s=n.next});return t})}async function pe(){return fetch("https://api.spotify.com/v1/me/player/devices",{headers:l.accessTokenHeader,method:"GET"}).then(e=>e.json()).then(e=>e.devices)}function ye(e){const t=document.createElement("div");t.classList.add("device");const s=document.createElement("div");s.classList.add("device-is-selected-container");const n=document.createElement("p");n.classList.add("device-is-selected-text"),e.is_active&&(t.classList.add("selected"),n.innerText="Dispositivo seleccionado"),s.appendChild(n),t.appendChild(s);const i=document.createElement("div");i.classList.add("device-icon-container");const a=document.createElement("i");e.type==="Computer"?a.className="bi bi-laptop":e.type==="Smartphone"?a.className="bi bi-phone":e.type==="Speaker"&&(a.className="bi bi-speaker"),i.appendChild(a),t.appendChild(i);const c=document.createElement("div");c.classList.add("device-name-container");const b=document.createElement("p");return b.classList.add("device-name"),b.innerText=e.name,c.appendChild(b),t.appendChild(c),t}function H(e,t){const s=document.createElement("div");s.classList.add("simplified-playlist-container"),t&&s.classList.add("selectable");const n=document.createElement("img");n.classList.add("simplified-playlist-image"),e.images.length!==0&&n.setAttribute("src",e.images[0].url);const i=document.createElement("p");i.classList.add("simplified-playlist-name"),i.innerText=e.name;const a=document.createElement("p");return a.classList.add("simplified-playlist-description"),e.description?a.innerText=e.description:a.innerText=`De ${e.owner.display_name}`,s.appendChild(n),s.appendChild(i),s.appendChild(a),s}async function he(e){return fetch("https://api.spotify.com/v1/me/player",{headers:l.accessTokenHeader,method:"PUT",body:JSON.stringify({device_ids:[e]})})}async function ge(){return fetch("https://api.spotify.com/v1/me/playlists?limit=8",{method:"GET",headers:l.accessTokenHeader}).then(e=>e.json())}async function L(e){const s=["collaborative","description","external_urls","href","id","images","name","owner","public","snapshot_id","tracks(href,total)","type","uri"].join(",");return fetch(`https://api.spotify.com/v1/playlists/${e}?fields=${s}`,{method:"GET",headers:l.accessTokenHeader}).then(n=>n.json())}const I=class{static savePlaylistId(t){const s=this.ids.indexOf(t);return s!==-1&&this.ids.splice(s,1),console.log(t),this.ids.unshift(t),console.log(this.ids),localStorage.setItem(this.storageName,JSON.stringify(this.ids)),s}static getPlaylistsIds(){return this.ids}};let m=I;r(m,"storageName","play_again_playlists_ids"),r(m,"ids",JSON.parse(localStorage.getItem(I.storageName)||"[]"));async function fe(){return pe().then(e=>{const t=document.getElementById("devices-list");for(const s of e){const n=ye(s);n.addEventListener("click",async()=>{if(s.id){await he(s.id);for(let i=0;i<t.children.length;i++){const a=t.children[i];a.classList.remove("selected"),a.getElementsByClassName("device-is-selected-text")[0].innerHTML=""}n.classList.add("selected"),n.getElementsByClassName("device-is-selected-text")[0].innerHTML="Dispositivo selecionado",document.getElementById("no-device-selected").style.display="none"}}),t.appendChild(n)}e.length===0?document.getElementById("no-devices-found").style.display="block":e.some(s=>s.is_active)||(document.getElementById("no-device-selected").style.display="block")})}function E(e,t){for(const s of e){const n=H(s,!0);n.addEventListener("click",async()=>{const i=s.id,a=await O(i);w(a,i)}),t.appendChild(n)}}async function Ee(){return ge().then(e=>{const t=document.getElementById("user-playlists-list"),s=document.getElementById("user-playlists-load-more");E(e.items,t);let n=e.next;n?s.onclick=()=>{fetch(n,{method:"GET",headers:l.accessTokenHeader}).then(i=>i.json()).then(i=>{E(i.items,t),n=i.next,n||(s.style.display="none")})}:s.style.display="none"})}async function ve(){const e=m.getPlaylistsIds(),t=document.getElementById("play-again-list"),s=document.getElementById("play-again-load-more"),n=8;let i=0;return Promise.all(e.slice(i,i+n).map(async a=>L(a))).then(a=>{E(a,t),i+=n,i>=e.length?s.style.display="none":s.onclick=()=>{Promise.all(e.slice(i,i+n).map(async c=>L(c))).then(c=>{E(c,t),i+=n,i>=e.length&&(s.style.display="none")})}})}async function be(){await Promise.all([fe(),Ee(),ve()])}function w(e,t){const s=document.getElementById("play-again-list");me(e,t);const n=m.savePlaylistId(t);n!==-1&&s.children.length>n&&s.removeChild(s.children[n]);const i=H(e,!0);i.addEventListener("click",async()=>{w(e,t)}),s.insertBefore(i,s.children[0])}document.addEventListener("DOMContentLoaded",async()=>{var e;(e=document.getElementById("playlist-form"))==null||e.addEventListener("submit",async t=>{t.preventDefault();const s=document.getElementById("playlist-input").value;try{const n=ee(s),i=await O(n);w(i,n)}catch(n){console.log(n)}})});const x="b3c2339a149d46afa94a39347466b623",ke=new URLSearchParams(window.location.search),C=ke.get("code");document.addEventListener("DOMContentLoaded",async()=>{y("empty-page"),C?(l.accessToken=await j(x,C),l.country=await J(),await be(),y("home-page")):$(x)});
